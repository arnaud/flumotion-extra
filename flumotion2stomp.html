<!doctype html>
 <html>

<head>
 <script>document.domain=document.domain</script>
 <script type="text/javascript" src="http://localhost:8000/static/Orbited.js"></script>
 <script>
 Orbited.settings.port = 8000;
 TCPSocket = Orbited.TCPSocket;
 </script>
 <script type="text/javascript" src="http://localhost:8000/static/protocols/stomp/stomp.js"></script>

 <script type="text/javascript" src="json2.js"></script>
 <script type="text/javascript" src="jquery-1.4.4.min.js"></script>
 <script type="text/javascript" src="jquery.expander.js"></script>
 <script type="text/javascript">

 var POLL_CHANNEL = '/flumotion/poll';
 var INITIAL_CHANNEL = '/flumotion/components/initial';
 var CHANGES_CHANNEL = '/flumotion/components/changes';
 var UISTATE_CHANNEL = '/flumotion/components/uistate';
 var OVERALL_MOOD = -1;
 
 var STREAMER_CLIENTS = Array();
 var stomp = new STOMPClient();
 var GREEN = "#0f0";
 var RED = "#f00";
 var YELLOW = "#ff0";
 var ORANGE = "#f80";

 function initial_receive( msg ) {
 console.log('received initial message', msg);
 $.each(msg, function(index,value) {
   add_component (value);
 });
 }

 function change_overall_mood() {
   var mood = "happy";
   if ($('div.hungry').length > 0) mood = "hungry";
   if ($('div.waking').length > 0) mood = "waking";
   if ($('div.sleeping').length > 0) mood = "sleeping";
   if ($('div.lost').length > 0) mood = "lost";
   if ($('div.sad').length > 0) mood = "sad";

   $("#components").attr('class', mood);
 }

 function get_mood_string(mood) {
   var smood = "happy";
   if (mood == 0) smood = "happy";
   else if (mood == 1) smood = "hungry";
   else if (mood == 2) smood = "waking";
   else if (mood == 3) smood = "sleeping";
   else if (mood == 4) smood = "lost";
   else if (mood == 5) smood = "sad";
   return smood;
 }
 function add_component( value ) {
   mood = get_mood_string(value["mood"]);
 
   var section = "misc";
   if (value["type"].indexOf("http-") != -1) section = "streamers";
   else if (value["type"].indexOf("producer") != -1) section = "producers";
   else if (value["type"].indexOf("encoder") != -1) section = "encoders";
   else if (value["type"].indexOf("muxer") != -1) section = "encoders";
   else if (value["type"].indexOf("disk-consumer") != -1) section = "diskers";
   else if (value["type"].indexOf("pipeline-converter") != -1) section = "encoders";
   var componentname = value["name"].replace(/\./g, "__");
   var elementname = "component-" + componentname;
   $("#" + section).append('<div id="' + elementname + '" class="' + mood + '">' + value["name"] + '</div>');
   change_overall_mood();
   if (value["messages"].length > 0) {
     for(i=0;i<value["messages"].length;i++) {
       m = value["messages"][i];
       $('#messages').append('<div class="flumotion-message" id="message-' + componentname + '">On component <b>' + value["name"] + "</b>:" + m["text"] + "</div>");
       $('div.flumotion-message').expander();
     }
   }
   // do not continue if mood is not happy
   if (value["mood"] != 0) return;
   else listen_for_stuff(value);
 }

 function listen_for_stuff(value) {
   if (value["type"].indexOf("http-") != -1 || value["type"] == 'disk-consumer') {
      var channel_name = UISTATE_CHANNEL + "/" + value["name"];
      if (value["type"] == "disk-consumer") channel_name = channel_name + "/filename";
      else channel_name = channel_name + "/clients-current";
      console.log("subscribing to " + channel_name);
      stomp.subscribe(channel_name);
      stomp.send(value["name"], POLL_CHANNEL);
   }
   if (value["type"] == "firewire-producer" || value["type"] == "soundcard-producer") {
     var channel_name = UISTATE_CHANNEL + "/" + value["name"] + '/volume-peak';
     stomp.subscribe(channel_name);
     stomp.send(value["name"], POLL_CHANNEL);
     $('#input').append('<canvas id="volumeleft-' + value["name"] + '" width="250" height="30"></canvas><canvas id="volumeright-' + value["name"] + '" width="250" height="30"></canvas>')
     ctx = document.getElementById('volumeleft-' + value['name']).getContext("2d");
     ctx.fillStyle = '#000';
     ctx.fillRect(0, 0, 250, 30);
     ctx = document.getElementById('volumeright-' + value['name']).getContext("2d");
     ctx.fillStyle = '#000';
     ctx.fillRect(0, 0, 250, 30);

   }
 }

 function stop_listening_for_stuff(value) {
   var componentname = value["name"].replace(/\./g, "__");

   if (value["type"].indexOf("http-") != -1 || value["type"] == 'disk-consumer') {
      var channel_name = UISTATE_CHANNEL + "/" + value["name"];
      if (value["type"] == "disk-consumer") {
        channel_name = channel_name + "/filename";
        $('#filename-' + componentname).remove();
      }
      else {
         channel_name = channel_name + "/clients-current";
         console.log("unsubscribing to " + channel_name);
         stomp.unsubscribe(channel_name);
         STREAMER_CLIENTS[componentname] = 0;
         update_streamer_clients();
      }
   }
   if (value["type"] == "firewire-producer" || value["type"] == "soundcard-producer") {
     var channel_name = UISTATE_CHANNEL + "/" + value["name"] + '/volume-peak';
     stomp.unsubscribe(channel_name);
     $('#volumeleft-' + value["name"]).remove();
     $('#volumeright-' + value['name']).remove();
   }
 }

 function changes_receive ( msg ) {
   console.log('received changes message', msg);
   var value = msg["component"]

   if (msg["action"] == "change") {
     console.log("change to component " + value["name"]);
     var mood = get_mood_string(value["mood"]);
     var elementname = "#component-" + value["name"].replace(/\./g, "__");
     if ($(elementname).attr("class") != mood) {
       $(elementname).attr("class", mood);
       if (value["mood"] > OVERALL_MOOD) change_overall_mood(value["mood"]);
       if (value["mood"] == 0) {
          console.log(value["name"] + " went happy");
          listen_for_stuff(value);
       }
       else stop_listening_for_stuff(value);
     }
   }
   else if (msg["action"] == "add") {
     console.log("new component " + value["name"]);
     add_component(value);
   }
   else if (msg["action"] == "remove") {
     console.log("component " + value + " removed");
     var componentname = value.replace(/\./g, "__");
     var elementname = "#component-" + componentname;
     var c = $(elementname);
     console.log($(elementname).attr('id') + " being removed");
     $(elementname).fadeOut(500, function() { $(elementname).remove(); change_overall_mood(); });
     $("#message-" + componentname).remove();
   }
 }

function uistate_receive(destination, value) {
  destsplit = destination.split('/');
  var componentname = destsplit[4].replace(/\./g, "__");
  if (destsplit[5] == "filename") {
    console.log("component " + destsplit[4] + " has changed filename to " + value);
    var str = destsplit[4];
    if (value == null) str = str + " is not recording";
    else str = str + ' is recording to filename ' + value;
    if ($("#filename-" + componentname).length == 0) {
      $("#recordingsummary").append('<div id="filename-' + componentname + '">' + str + '</div>');
    }
    else {
      $("#filename-" + componentname).html(str);
    }
      
  }
  else if (destsplit[5] == 'clients-current') {
    STREAMER_CLIENTS[componentname] = parseInt(value);
    update_streamer_clients();
    console.log("component " + destsplit[4] + " has clients " + value);
  }
  else if (destsplit[5].indexOf('volume-') != -1) {
    draw_volume(destsplit[4], value);
  }
}

function iec_scale(db) {
  var pct = 0.0

  if (db < -70.0) pct = 0.0;
  else if (db < -60.0) pct = (db + 70.0) * 0.25;
  else if (db < -50.0) pct = (db + 60.0) * 0.5 + 2.5;
  else if (db < -40.0) pct = (db + 50.0) * 0.75 + 7.5;
  else if (db < -30.0) pct = (db + 40.0) * 1.5 + 15.0;
  else if (db < -20.0) pct = (db + 30.0) * 2.0 + 30.0;
  else if (db < 0.0)   pct = (db + 20.0) * 2.5 + 50.0
  else pct = 100.0;
  return pct;
}
function draw_volume(component, peaks) {
  for(i=0;i<=1;i++) {
    var channel = "left";
    if (i == 1)
      channel = "right";
    ctx = document.getElementById('volume' + channel + '-' + component).getContext("2d");
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, 250, 30);
    peaklevelpct = iec_scale(peaks[i]);
    peakwidth = 250.0 * peaklevelpct/100.0;
    orangethreshold = -10.0;
    redthreshold = -1.0;
    ctx.fillStyle = GREEN;
    if (peaks[i] >= orangethreshold) ctx.fillStyle = ORANGE;
    if (peaks[i] >= redthreshold) ctx.fillStyle = RED;
    if (peakwidth > 0) ctx.fillRect(0, 0, peakwidth, 30);
  }
}
  
function update_streamer_clients() {
  var total_clients = 0;
  for (i in STREAMER_CLIENTS) {
    total_clients = total_clients + STREAMER_CLIENTS[i];
  }
  $('#listeners').html("Total clients: " + total_clients);
}
 $(document).ready(function() {
   // set up stomp client.
   stomp.onconnectedframe = function() {
     // Run on initial connection to STOMP (comet) server
     stomp.ready = true;
     // subscribe to channel CHANNEL = "/ezchat/"
     stomp.subscribe(INITIAL_CHANNEL);
   };

   stomp.onmessageframe = function(frame) {
     // Executed when a messge is received
     //console.log('frame is', frame);
     if (frame.headers["destination"] == "/flumotion/components/initial") {
       initial_receive( JSON.parse(frame.body) );
       stomp.unsubscribe(INITIAL_CHANNEL);
       stomp.subscribe(CHANGES_CHANNEL);
     }
     else if (frame.headers['destination'] == '/flumotion/components/changes') {
       changes_receive ( JSON.parse(frame.body) );
     }
     else if (frame.headers['destination'].indexOf('/flumotion/components/uistate') != -1) {
       uistate_receive(frame.headers['destination'], JSON.parse(frame.body) );
     }
   };

   // Everything is setup. Start the connection!
   stomp.connect(document.domain, 61613); //, 'guest', 'guest');
});
 </script>
 <style>
  #summary {position:absolute;left:20px;top:0px;}
  #components {position:absolute;right:20px;top:0px;}
  .happy:before {content:url('images/mood-happy.png')}
  .hungry:before {content:url('images/mood-hungry.png')}
  .sleeping:before {content:url('images/mood-sleeping.png')}
  .sad:before {content:url('images/mood-sad.png')}
  .lost:before {content:url('images/mood-lost.png')}
  .waking:before {content:url('images/mood-waking.png')}
 </style>
</head>

<body>
<div id="summary">
<h2>Summary</h2>
<div id="recordingsummary">
<h3>Recordings</h3></div>
<div id="streamingsummary">
<h3>Streaming</h3>
<div id="listeners"></div>
</div>
<div id="input">
<h3>Input</h3>
</div>
<div id="messages">
<h2>Messages</h2>
</div>
</div>
<span id="components">
<h3>Producers</h3>
<div id="producers"></div>
<h3>Encoders and Muxers</h3>
<div id="encoders"></div>
<h3>Streamers</h3>
<div id="streamers"></div>
<h3>Recording</h3>
<div id="diskers"></div>
<h3>Miscellaneous</h3>
<div id="misc"></div>
</span>
</body>

</html>
